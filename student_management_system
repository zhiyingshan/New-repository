//student_management_system
//A simple student management system implemented in C.
#include <stdio.h>
#include <stdlib.h>
#include <string.h>

/* 
学生管理系统-1.0
开发者：植颖珊
功能：实现学生信息的增删改查及文件存储
注：为方便老师和项目负责人浏览，已将全部代码添加内容注解 ，请放心观看 
 */

// 1. 定义学生结构体
struct Student {
    int id;           // 学号
    char name[50];    // 姓名
    float score;      // 成绩
    int age;          // 年龄
    char major[30];   // 专业
};

// 2. 全局变量
#define MAX_STUDENTS 100  // 最大学生数
struct Student students[MAX_STUDENTS];  // 学生数组
int student_count = 0;    // 当前学生数量
char filename[] = "students.dat"; // 数据文件名

// 3. 函数声明
void display_menu();
void add_student();
void display_all();
void search_student();
void update_student();
void delete_student();
void save_to_file();
void load_from_file();
void statistics();
void clear_input_buffer();

// 清除输入缓冲区
void clear_input_buffer() {
    int c;
    while ((c = getchar()) != '\n' && c != EOF);
}

// 从文件加载数据
void load_from_file() {
    FILE *file = fopen(filename, "rb");  // 二进制读取
    
    if (file == NULL) {
        printf("数据文件不存在，将创建新文件。\n");
        student_count = 0;
        return;
    }
    
    // 读取学生数量
    fread(&student_count, sizeof(int), 1, file);
    
    // 检查数量是否合理
    if (student_count < 0 || student_count > MAX_STUDENTS) {
        printf("数据文件损坏！\n");
        student_count = 0;
        fclose(file);
        return;
    }
    
    // 读取所有学生数据
    int i;  // 循环变量在循环外声明
    for (i = 0; i < student_count; i++) {
        fread(&students[i], sizeof(struct Student), 1, file);
    }
    
    fclose(file);
    printf("从文件 '%s' 加载了 %d 条学生记录。\n", filename, student_count);
}

// 显示菜单
void display_menu() {
    printf("\n============ 主菜单 ============\n");
    printf("1. 添加学生信息\n");
    printf("2. 显示所有学生\n");
    printf("3. 查找学生信息\n");
    printf("4. 修改学生信息\n");
    printf("5. 删除学生信息\n");
    printf("6. 保存数据到文件\n");
    printf("7. 从文件加载数据\n");
    printf("8. 数据统计与分析\n");
    printf("9. 退出系统\n");
    printf("================================\n");
}

int main() {
    printf("========================================\n");
    printf("    学生信息管理系统 v1.0\n");
    printf("    开发者：植颖珊\n");
    printf("========================================\n");
    
    // 程序启动时加载已有数据
    load_from_file();
    printf("系统初始化完成，已加载 %d 条学生记录。\n\n", student_count);
    
    int choice;
    
    do {
        display_menu();
        printf("请输入您的选择 (1-9): ");
        
        // 处理输入，防止输入字符导致死循环
        if (scanf("%d", &choice) != 1) {
            printf("输入错误！请输入数字。\n");
            clear_input_buffer();
            continue;
        }
        
        clear_input_buffer(); // 清除输入缓冲区
        
        switch (choice) {
            case 1:
                add_student();
                break;
            case 2:
                display_all();
                break;
            case 3:
                search_student();
                break;
            case 4:
                update_student();
                break;
            case 5:
                delete_student();
                break;
            case 6:
                save_to_file();
                break;
            case 7:
                load_from_file();
                break;
            case 8:
                statistics();
                break;
            case 9:
                printf("\n感谢使用学生管理系统！\n");
                printf("数据已自动保存。\n");
                save_to_file(); // 退出前自动保存
                break;
            default:
                printf("无效的选择！请重新输入。\n");
        }
        
        printf("\n");
        system("pause");  // 按任意键继续
        
    } while (choice != 9);
    
    return 0;
}

// 添加学生
void add_student() {
    if (student_count >= MAX_STUDENTS) {
        printf("错误：学生数量已达上限 (%d)！\n", MAX_STUDENTS);
        return;
    }
    
    struct Student new_student;
    
    printf("\n----- 添加学生信息 -----\n");
    
    // 输入学号
    printf("请输入学号: ");
    while (scanf("%d", &new_student.id) != 1) {
        printf("输入错误！请输入数字学号: ");
        clear_input_buffer();
    }
    clear_input_buffer();
    
    // 检查学号是否重复
    int i;  // 循环变量在循环外声明
    for (i = 0; i < student_count; i++) {
        if (students[i].id == new_student.id) {
            printf("错误：学号 %d 已存在！\n", new_student.id);
            return;
        }
    }
    
    // 输入姓名
    printf("请输入姓名: ");
    fgets(new_student.name, sizeof(new_student.name), stdin);
    // 移除末尾的换行符
    new_student.name[strcspn(new_student.name, "\n")] = '\0';
    
    // 输入年龄
    printf("请输入年龄: ");
    while (scanf("%d", &new_student.age) != 1 || new_student.age <= 0) {
        printf("输入错误！请输入正确年龄: ");
        clear_input_buffer();
    }
    clear_input_buffer();
    
    // 输入专业
    printf("请输入专业: ");
    fgets(new_student.major, sizeof(new_student.major), stdin);
    new_student.major[strcspn(new_student.major, "\n")] = '\0';
    
    // 输入成绩
    printf("请输入成绩 (0-100): ");
    while (scanf("%f", &new_student.score) != 1 || 
           new_student.score < 0 || new_student.score > 100) {
        printf("输入错误！请输入0-100之间的成绩: ");
        clear_input_buffer();
    }
    clear_input_buffer();
    
    // 添加到数组
    students[student_count] = new_student;
    student_count++;
    
    printf("\n学生信息添加成功！\n");
    printf("当前学生总数: %d\n", student_count);
}

// 显示所有学生
void display_all() {
    if (student_count == 0) {
        printf("\n当前没有学生记录。\n");
        return;
    }
    
    printf("\n============ 所有学生信息 ============\n");
    printf("%-8s %-20s %-6s %-15s %-6s\n", 
           "学号", "姓名", "年龄", "专业", "成绩");
    printf("------------------------------------------------------------\n");
    
    float total_score = 0;
    float max_score = 0;
    float min_score = 100;
    
    int i;  // 循环变量在循环外声明
    for (i = 0; i < student_count; i++) {
        printf("%-8d %-20s %-6d %-15s %-6.1f\n",
               students[i].id,
               students[i].name,
               students[i].age,
               students[i].major,
               students[i].score);
        
        total_score += students[i].score;
        if (students[i].score > max_score) max_score = students[i].score;
        if (students[i].score < min_score) min_score = students[i].score;
    }
    
    printf("------------------------------------------------------------\n");
    printf("统计信息：\n");
    printf("  学生总数: %d\n", student_count);
    printf("  平均成绩: %.1f\n", student_count > 0 ? total_score / student_count : 0);
    printf("  最高分: %.1f\n", max_score);
    printf("  最低分: %.1f\n", min_score);
}

// 查找学生
void search_student() {
    if (student_count == 0) {
        printf("\n当前没有学生记录。\n");
        return;
    }
    
    int choice;
    printf("\n----- 查找学生 -----\n");
    printf("1. 按学号查找\n");
    printf("2. 按姓名查找\n");
    printf("请选择查找方式: ");
    
    scanf("%d", &choice);
    clear_input_buffer();
    
    if (choice == 1) {
        int search_id;
        printf("请输入要查找的学号: ");
        scanf("%d", &search_id);
        clear_input_buffer();
        
        int found = 0;
        int i;  
        for (i = 0; i < student_count; i++) {
            if (students[i].id == search_id) {
                printf("\n找到学生信息：\n");
                printf("学号: %d\n", students[i].id);
                printf("姓名: %s\n", students[i].name);
                printf("年龄: %d\n", students[i].age);
                printf("专业: %s\n", students[i].major);
                printf("成绩: %.1f\n", students[i].score);
                found = 1;
                break;
            }
        }
        if (!found) {
            printf("未找到学号为 %d 的学生。\n", search_id);
        }
        
    } else if (choice == 2) {
        char search_name[50];
        printf("请输入要查找的姓名: ");
        fgets(search_name, sizeof(search_name), stdin);
        search_name[strcspn(search_name, "\n")] = '\0';
        
        int found = 0;
        printf("\n查找结果：\n");
        int i; 
        for (i = 0; i < student_count; i++) {
            if (strstr(students[i].name, search_name) != NULL) {
                printf("学号: %d, 姓名: %s, 专业: %s, 成绩: %.1f\n",
                       students[i].id, students[i].name, 
                       students[i].major, students[i].score);
                found = 1;
            }
        }
        if (!found) {
            printf("未找到姓名为 '%s' 的学生。\n", search_name);
        }
        
    } else {
        printf("无效的选择！\n");
    }
}

// 修改学生信息
void update_student() {
    if (student_count == 0) {
        printf("\n当前没有学生记录。\n");
        return;
    }
    
    int search_id;
    printf("\n----- 修改学生信息 -----\n");
    printf("请输入要修改的学生学号: ");
    scanf("%d", &search_id);
    clear_input_buffer();
    
    int index = -1;
    int i;  
    for (i = 0; i < student_count; i++) {
        if (students[i].id == search_id) {
            index = i;
            break;
        }
    }
    
    if (index == -1) {
        printf("未找到学号为 %d 的学生。\n", search_id);
        return;
    }
    
    printf("\n找到学生: %s (当前信息)\n", students[index].name);
    printf("1. 姓名: %s\n", students[index].name);
    printf("2. 年龄: %d\n", students[index].age);
    printf("3. 专业: %s\n", students[index].major);
    printf("4. 成绩: %.1f\n", students[index].score);
    
    int field;
    printf("\n请选择要修改的字段 (1-4, 0取消): ");
    scanf("%d", &field);
    clear_input_buffer();
    
    switch (field) {
        case 0:
            printf("修改已取消。\n");
            break;
        case 1:
            printf("请输入新姓名: ");
            fgets(students[index].name, sizeof(students[index].name), stdin);
            students[index].name[strcspn(students[index].name, "\n")] = '\0';
            printf("姓名修改成功！\n");
            break;
        case 2:
            printf("请输入新年龄: ");
            while (scanf("%d", &students[index].age) != 1 || students[index].age <= 0) {
                printf("输入错误！请输入正确年龄: ");
                clear_input_buffer();
            }
            clear_input_buffer();
            printf("年龄修改成功！\n");
            break;
        case 3:
            printf("请输入新专业: ");
            fgets(students[index].major, sizeof(students[index].major), stdin);
            students[index].major[strcspn(students[index].major, "\n")] = '\0';
            printf("专业修改成功！\n");
            break;
        case 4:
            printf("请输入新成绩 (0-100): ");
            while (scanf("%f", &students[index].score) != 1 || 
                   students[index].score < 0 || students[index].score > 100) {
                printf("输入错误！请输入0-100之间的成绩: ");
                clear_input_buffer();
            }
            clear_input_buffer();
            printf("成绩修改成功！\n");
            break;
        default:
            printf("无效的选择！\n");
    }
}

// 删除学生
void delete_student() {
    if (student_count == 0) {
        printf("\n当前没有学生记录。\n");
        return;
    }
    
    int search_id;
    printf("\n----- 删除学生信息 -----\n");
    printf("请输入要删除的学生学号: ");
    scanf("%d", &search_id);
    clear_input_buffer();
    
    int index = -1;
    int i;
    for (i = 0; i < student_count; i++) {
        if (students[i].id == search_id) {
            index = i;
            break;
        }
    }
    
    if (index == -1) {
        printf("未找到学号为 %d 的学生。\n", search_id);
        return;
    }
    
    printf("确认删除学生: %s (学号: %d) 吗？(y/n): ", 
           students[index].name, students[index].id);
    
    char confirm;
    scanf("%c", &confirm);
    clear_input_buffer();
    
    if (confirm == 'y' || confirm == 'Y') {
        // 将后面的元素向前移动
        for (i = index; i < student_count - 1; i++) {
            students[i] = students[i + 1];
        }
        student_count--;
        printf("学生信息删除成功！\n");
    } else {
        printf("删除操作已取消。\n");
    }
}

// 保存数据到文件
void save_to_file() {
    FILE *file = fopen(filename, "wb");  // 二进制写入
    
    if (file == NULL) {
        printf("无法打开文件进行保存！\n");
        return;
    }
    
    // 先保存学生数量
    fwrite(&student_count, sizeof(int), 1, file);
    
    // 保存所有学生数据
    int i;
    for (i = 0; i < student_count; i++) {
        fwrite(&students[i], sizeof(struct Student), 1, file);
    }
    
    fclose(file);
    printf("数据已保存到文件 '%s'，共 %d 条记录。\n", filename, student_count);
}

// 数据统计与分析
void statistics() {
    if (student_count == 0) {
        printf("\n当前没有学生记录。\n");
        return;
    }
    
    printf("\n============ 数据统计与分析 ============\n");
    
    float total_score = 0;
    float max_score = 0;
    float min_score = 100;
    int max_index = 0, min_index = 0;
    
    // 统计各分数段人数
    int level_A = 0, level_B = 0, level_C = 0, level_D = 0, level_F = 0;
    
    int i;
    for (i = 0; i < student_count; i++) {
        float score = students[i].score;
        total_score += score;
        
        if (score > max_score) {
            max_score = score;
            max_index = i;
        }
        if (score < min_score) {
            min_score = score;
            min_index = i;
        }
        
        // 分数段统计
        if (score >= 90) level_A++;
        else if (score >= 80) level_B++;
        else if (score >= 70) level_C++;
        else if (score >= 60) level_D++;
        else level_F++;
    }
    
    float average = total_score / student_count;
    
    printf("基本统计：\n");
    printf("  学生总数: %d\n", student_count);
    printf("  平均成绩: %.2f\n", average);
    printf("  最高分: %.1f (%s, %s)\n", 
           max_score, students[max_index].name, students[max_index].major);
    printf("  最低分: %.1f (%s, %s)\n", 
           min_score, students[min_index].name, students[min_index].major);
    
    printf("\n分数段分布：\n");
    printf("  A (90-100): %d人 (%.1f%%)\n", level_A, (float)level_A/student_count*100);
    printf("  B (80-89):  %d人 (%.1f%%)\n", level_B, (float)level_B/student_count*100);
    printf("  C (70-79):  %d人 (%.1f%%)\n", level_C, (float)level_C/student_count*100);
    printf("  D (60-69):  %d人 (%.1f%%)\n", level_D, (float)level_D/student_count*100);
    printf("  F (<60):    %d人 (%.1f%%)\n", level_F, (float)level_F/student_count*100);
    
    // 专业统计
    printf("\n各专业平均成绩：\n");
    // 这里简化处理，实际应该用结构体存储专业统计
    printf("  (专业统计功能需要更复杂的数据结构实现)\n");
}
